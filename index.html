<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DevChat Terminal</title>
  <style>
    body, html {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: "Courier New", monospace;
      background-color: #111;
      color: #0f0;
    }

    .modal {
      position: fixed;
      top: 0; left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.95);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .modal-content {
      background-color: #000;
      padding: 20px;
      border: 1px solid #0f0;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .modal-content input, .modal-content button {
      margin: 10px;
      padding: 10px;
      border: none;
      font-size: 16px;
      background-color: #222;
      color: #0f0;
      width: 250px;
    }

    .modal-content button {
      background-color: #0f0;
      color: #111;
      cursor: pointer;
    }

    .terminal {
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      padding: 10px;
      overflow-y: auto;
      font-size: 18px;
      background-color: black;
      display: none;
    }

    .command-line {
      display: flex;
      margin-top: auto;
      gap: 10px;
      align-items: center;
    }

    #command-input {
      flex: 1;
      background-color: #000;
      color: #0f0;
      border: none;
      font-family: "Courier New", monospace;
      font-size: 16px;
      padding: 10px;
    }

    .output p {
      margin: 5px 0;
    }

    .code-block {
      background-color: #222;
      padding: 10px;
      border-radius: 5px;
      color: #f0f0f0;
      font-size: 16px;
      white-space: pre-wrap;
      word-wrap: break-word;
      margin-top: 10px;
    }

    .channel-header {
      font-size: 20px;
      margin-top: 10px;
      color: #0f0;
    }
  </style>
</head>
<body>
  <!-- Login Modal -->
  <div class="modal" id="login-modal">
    <div class="modal-content">
      <h2 style="color:#0f0;">DevChat Login</h2>
      <input type="email" id="email" placeholder="Email">
      <input type="password" id="password" placeholder="Password">
      <button id="login-button">Login</button>
      <button id="register-button">Register</button>
    </div>
  </div>

  <!-- Terminal Chat -->
  <div class="terminal" id="terminal">
    <div id="console-output" class="output"></div>
    <div class="command-line">
      <span>devchat@user:~$</span>
      <input type="text" id="command-input" placeholder="Type a command..." />
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import {
      getAuth,
      signInWithEmailAndPassword,
      createUserWithEmailAndPassword,
      signOut,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import {
      getFirestore,
      collection,
      addDoc,
      onSnapshot,
      serverTimestamp,
      query,
      orderBy
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyAe8kZK1EtKX92L2Sopk5uSi2PDTzMtH6M",
      authDomain: "devchat-97f99.firebaseapp.com",
      projectId: "devchat-97f99",
      storageBucket: "devchat-97f99.appspot.com",
      messagingSenderId: "778378732801",
      appId: "1:778378732801:web:2b668fa9c6a22d6a8f2700"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const loginModal = document.getElementById("login-modal");
    const terminal = document.getElementById("terminal");
    const consoleOutput = document.getElementById("console-output");
    const commandInput = document.getElementById("command-input");

    let currentChannel = "general"; // Default channel

    const logToConsole = (message) => {
      const p = document.createElement("p");
      p.textContent = message;
      consoleOutput.appendChild(p);
      consoleOutput.scrollTop = consoleOutput.scrollHeight;
    };

    const showTerminal = () => {
      loginModal.style.display = "none";
      terminal.style.display = "flex";
      logToConsole(`Welcome to DevChat! Current channel: #${currentChannel}`);
      displayChannelMessages();
    };

    const handleLogin = () => {
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;
      if (!email || !password) return;

      signInWithEmailAndPassword(auth, email, password)
        .then(() => {
          logToConsole(`Logged in as ${email}`);
          showTerminal();
        })
        .catch(err => {
          alert("Login failed: " + err.message);
        });
    };

    const handleRegister = () => {
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;
      if (!email || !password) return;

      createUserWithEmailAndPassword(auth, email, password)
        .then(() => {
          alert("Registered! Now log in.");
        })
        .catch(err => {
          alert("Registration failed: " + err.message);
        });
    };

    // Login/Register buttons
    document.getElementById("login-button").addEventListener("click", handleLogin);
    document.getElementById("register-button").addEventListener("click", handleRegister);

    // Auth check
    onAuthStateChanged(auth, (user) => {
      if (user) {
        showTerminal();
      }
    });

    const displayChannelMessages = () => {
      const messagesRef = collection(db, `rooms/${currentChannel}/messages`);
      const q = query(messagesRef, orderBy("timestamp"));

      onSnapshot(q, (snapshot) => {
        consoleOutput.innerHTML = ""; // Clear + reload all
        snapshot.forEach((doc) => {
          const msg = doc.data();
          const sender = msg.sender.split("@")[0];
          logToConsole(`devchat@${sender}:~# ${msg.text}`);
        });
      });
    };

    commandInput.addEventListener("keypress", async (e) => {
      if (e.key === "Enter") {
        const command = commandInput.value.trim();
        commandInput.value = "";

        const user = auth.currentUser;
        const email = user?.email || "guest";

        if (command.startsWith("join ")) {
          const channel = command.slice(5).trim();
          currentChannel = channel;
          logToConsole(`Joined channel: #${currentChannel}`);
          displayChannelMessages();
        } else if (command.startsWith("show code")) {
          const code = `
            function sayHello() {
              console.log('Hello, DevChat!');
            }
            sayHello();
          `;
          const codeBlock = document.createElement("div");
          codeBlock.classList.add("code-block");
          codeBlock.textContent = code;
          consoleOutput.appendChild(codeBlock);
          consoleOutput.scrollTop = consoleOutput.scrollHeight;
        } else if (command.startsWith("send ")) {
          const text = command.slice(5);
          await addDoc(collection(db, `rooms/${currentChannel}/messages`), {
            sender: email,
            text,
            timestamp: serverTimestamp()
          });
        } else if (command === "clear") {
          consoleOutput.innerHTML = "";
        } else if (command === "logout") {
          await signOut(auth);
          terminal.style.display = "none";
          loginModal.style.display = "flex";
        } else if (command === "help") {
          logToConsole("Commands: join [channel], show code, send [msg], clear, logout, help");
        } else {
          logToConsole("Unknown command. Type 'help' for commands.");
        }
      }
    });
  </script>
</body>
</html>