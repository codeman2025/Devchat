<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>DevChat</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    .hidden { display: none; }
    .header { font-size: 24px; font-weight: bold; margin-bottom: 10px; }
    .message { border: 1px solid #ddd; padding: 10px; margin: 10px 0; }
    .btn { padding: 10px 20px; background-color: #4CAF50; color: white; border: none; cursor: pointer; }
    .btn:hover { background-color: #45a049; }
    #message-list { max-width: 500px; margin-top: 20px; }
  </style>
</head>
<body>

  <!-- Login/Register Page -->
  <div id="login-page">
    <h2 class="header">DevChat Login</h2>
    <input type="email" id="email" placeholder="Email" style="padding:10px;width:100%;margin-bottom:10px;" />
    <input type="password" id="password" placeholder="Password" style="padding:10px;width:100%;margin-bottom:10px;" />
    <button class="btn" onclick="login()">Login</button>
    <button class="btn" onclick="register()">Register</button>
  </div>

  <!-- Chat Page -->
  <div id="chat-page" class="hidden">
    <h2 class="header">Inbox</h2>
    <button class="btn" onclick="composeMessage()">Compose</button>
    <button class="btn" onclick="logout()">Logout</button>
    <div id="message-list"></div>
  </div>

  <!-- Compose Page -->
  <div id="compose-page" class="hidden">
    <h2 class="header">Compose Message</h2>
    <input type="text" id="recipient" placeholder="Recipient's Email" style="padding:10px;width:100%;margin-bottom:10px;" />
    <textarea id="message-content" placeholder="Your message..." style="padding:10px;width:100%;height:100px;margin-bottom:10px;"></textarea>
    <button class="btn" onclick="sendMessage()">Send</button>
    <button class="btn" onclick="goBack()">Back</button>
  </div>

<script type="module">
  // Import Firebase SDKs
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
  import { getFirestore, collection, addDoc, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyAe8kZK1EtKX92L2Sopk5uSi2PDTzMtH6M",
    authDomain: "devchat-97f99.firebaseapp.com",
    projectId: "devchat-97f99",
    storageBucket: "devchat-97f99.appspot.com",
    messagingSenderId: "778378732801",
    appId: "1:778378732801:web:2b668fa9c6a22d6a8f2700",
    measurementId: "G-5STVV3XZ0D"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  let currentUser = null;

  // Login function
  function login() {
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;
    signInWithEmailAndPassword(auth, email, password)
      .then((userCredential) => {
        currentUser = userCredential.user;
        console.log("Logged in:", currentUser.email);
        showChat();
        loadMessages();
      })
      .catch((error) => {
        alert("Login Failed: " + error.message);
      });
  }

  // Register function
  function register() {
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;
    createUserWithEmailAndPassword(auth, email, password)
      .then((userCredential) => {
        currentUser = userCredential.user;
        console.log("Registered:", currentUser.email);
        showChat();
      })
      .catch((error) => {
        alert("Registration Failed: " + error.message);
      });
  }

  // Logout
  function logout() {
    signOut(auth).then(() => {
      document.getElementById('chat-page').classList.add('hidden');
      document.getElementById('login-page').classList.remove('hidden');
      currentUser = null;
    });
  }

  // Show chat page
  function showChat() {
    document.getElementById('login-page').classList.add('hidden');
    document.getElementById('chat-page').classList.remove('hidden');
  }

  // Compose new message
  function composeMessage() {
    document.getElementById('chat-page').classList.add('hidden');
    document.getElementById('compose-page').classList.remove('hidden');
  }

  // Go back to inbox
  function goBack() {
    document.getElementById('compose-page').classList.add('hidden');
    document.getElementById('chat-page').classList.remove('hidden');
    loadMessages();
  }

  // Send new message
  async function sendMessage() {
    const recipient = document.getElementById('recipient').value;
    const message = document.getElementById('message-content').value;

    if (!recipient || !message) {
      alert("Fill in both fields!");
      return;
    }

    await addDoc(collection(db, "messages"), {
      sender: currentUser.email,
      recipient: recipient,
      message: message,
      timestamp: new Date()
    });

    alert("Message sent!");
    document.getElementById('recipient').value = "";
    document.getElementById('message-content').value = "";
    goBack();
  }

  // Load inbox messages
  async function loadMessages() {
    const messageList = document.getElementById('message-list');
    messageList.innerHTML = "";

    const q = query(collection(db, "messages"), orderBy("timestamp", "desc"));
    const querySnapshot = await getDocs(q);

    querySnapshot.forEach((doc) => {
      const data = doc.data();
      if (data.recipient === currentUser.email || data.sender === currentUser.email) {
        const div = document.createElement('div');
        div.className = "message";
        div.innerHTML = `<strong>${data.sender}</strong> âž” <strong>${data.recipient}</strong><br>${data.message}`;
        messageList.appendChild(div);
      }
    });
  }

</script>

</body>
</html>